# MOYAN Agent Infra - SaaS化架构设计

## 🎯 核心设计原则 (Linus Torvalds哲学)

> "好品味就是把特殊情况变成正常情况"

### 1. 多租户隔离策略

**方案选择：Schema级隔离（推荐）**
- 每个租户独立的Neo4j数据库（schema）
- Qdrant使用collections namespace (`tenant_id/collection_name`)
- 理由：平衡隔离性与运营成本

**备选方案：**
- 数据库级隔离：安全性最高，成本最高
- 行级隔离：成本最低，但需要复杂的权限控制

### 2. 整体架构蓝图

```
┌─────────────────────────────────────────────────────────┐
│                     负载均衡层                            │
│                 (Nginx/Cloudflare)                       │
└───────────────────┬─────────────────────────────────────┘
                    │
┌───────────────────▼─────────────────────────────────────┐
│                 API网关层                                │
│  - 认证/授权 (Auth0/Keycloak)                           │
│  - 限流/配额 (Redis + Token Bucket)                     │
│  - 路由 (Kong/APIM)                                     │
└───────────────────┬─────────────────────────────────────┘
                    │
┌───────────────────▼─────────────────────────────────────┐
│                业务服务层                                │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐    │
│  │  Agent API   │ │  Memory API  │ │ Video API    │    │
│  └──────────────┘ └──────────────┘ └──────────────┘    │
│  - FastAPI应用  - 记忆检索服务   - 视频处理服务          │
│  - 认证中间件   - 向量搜索      - 异步任务队列          │
└───────────────────┬─────────────────────────────────────┘
                    │
┌───────────────────▼─────────────────────────────────────┐
│                数据持久化层                              │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐    │
│  │   Neo4j      │ │   Qdrant     │ │  PostgreSQL  │    │
│  │ (多租户)     │ │ (多租户)     │ │  (配置/元数据)│    │
│  └──────────────┘ └──────────────┘ └──────────────┘    │
└───────────────────┬─────────────────────────────────────┘
                    │
┌───────────────────▼─────────────────────────────────────┐
│                基础设施层                                │
│  - 对象存储 (S3/MinIO)                                   │
│  - 缓存 (Redis Cluster)                                  │
│  - 消息队列 (RabbitMQ/Apache Kafka)                      │
│  - 监控 (Prometheus + Grafana)                           │
└─────────────────────────────────────────────────────────┘
```

## 🔧 关键改造点

### 1. API层改造
- **现状**：单用户FastAPI
- **目标**：多租户SaaS API
- **关键改动**：
  - 租户上下文中间件（从JWT提取tenant_id）
  - 基于租户的数据隔离
  - API版本管理（v1, v2等）
  - 统一错误处理与状态码

### 2. 数据层改造
- **Neo4j多租户**：
  ```cypher
  // 每个租户独立数据库
  CREATE DATABASE tenant_{tenant_id}_graph;
  USE tenant_{tenant_id}_graph;
  ```

- **Qdrant多租户**：
  ```
  Collection命名：{tenant_id}_{collection_name}
  例如：tenant_abc123_videos, tenant_xyz789_memories
  ```

- **配置管理**：
  - 每个租户独立的配置表
  - 支持租户自定义参数（模型选择、限流阈值等）

### 3. 计算资源隔离
- **内存模型隔离**：每个租户独立的向量索引缓存
- **GPU资源调度**：
  - 方案A：专用GPU实例（成本高但性能好）
  - 方案B：GPU共享池（成本优化，使用MIG/容器技术）
  - 推荐：混合方案（大客户专用，中小客户共享）

### 4. 成本优化策略
- **计算资源**：
  - 基于租户规模的实例规格
  - 自动缩放（Scale-to-Zero策略）
  - Spot实例用于非实时任务

- **存储成本**：
  - 冷热数据分离
  - 数据生命周期管理
  - 压缩与去重

## 🛡️ 安全设计

### 数据隔离级别
- **Level 1**: 逻辑隔离（代码级别检查） - 开发/测试环境
- **Level 2**: Schema隔离 - 多数企业客户
- **Level 3**: 数据库隔离 - 高安全要求客户
- **Level 4**: 物理隔离 - 合规客户（金融/医疗）

### 认证与授权
- **主认证**：OAuth 2.0 + OIDC
- **API密钥**：支持API Key + 限流
- **细粒度权限**：RBAC（基于角色）
  - 租户管理员（Tenant Admin）
  - 开发者（Developer）
  - 最终用户（End User）

## 📊 监控与SLA

### 关键指标
- **可用性SLA**：
  - 基础版：99.5%
  - 专业版：99.9%
  - 企业版：99.99%

- **性能指标**：
  - API延迟（P95 < 500ms）
  - 向量检索延迟（P95 < 200ms）
  - 视频处理队列等待 < 30s

### 监控方案
- **应用层**：Prometheus + Grafana
- **日志**：ELK Stack（Elasticsearch, Logstash, Kibana）
- **追踪**：Jaeger/Zipkin（OpenTelemetry）
- **告警**：AlertManager + PagerDuty

## 💰 定价模型

### 功能分级
- **Free Tier**：
  - 每月1,000 API调用
  - 100MB存储
  - 社区支持

- **Pro Tier ($99/月)**：
  - 100,000 API调用
  - 10GB存储
  - 邮件支持

- **Enterprise Tier (定制定价)**：
  - 无限制
  - 专属实例
  - SLA保障

### 计费维度
- **API调用**（主要）
- **存储量**（GB/月）
- **计算时间**（GPU小时）
- **数据流量**（GB）

## 🚀 实施路线图

### Phase 1: 基础SaaS化（4-6周）
- [ ] 多租户架构实现
- [ ] 认证授权系统
- [ ] 基础监控

### Phase 2: 规模化（4-6周）
- [ ] 自动缩放
- [ ] 成本优化
- [ ] 性能调优

### Phase 3: 企业化（6-8周）
- [ ] 高级安全特性
- [ ] SLA保障
- [ ] 企业集成

---

**设计哲学**：简单、清晰、可预测 - 让复杂度在架构中自然消化，而非留给用户。

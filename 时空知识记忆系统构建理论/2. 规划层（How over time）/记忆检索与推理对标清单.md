# 记忆检索与推理对标清单（V1.0 需求锚点）

本清单不是“功能菜单”，而是**用人类回想问题倒推图谱设计**的对标集：  
只要系统能在这些问题上给出稳定、可解释的回答，说明底层图结构与检索/推理路径是健康的。  
它直接约束 TKG-Graph-v1.0 的 Schema 与服务规划，并作为 v1.0 验收标准之一。

---

## 一、五个推理层级

每个层级给出典型自然语言问题、测试点与图谱/检索要求。  
实现时，至少需要两类验证：
- 低层：直接 Cypher / 图服务查询是否可表达并跑通；
- 高层：Memory API / Graph API 是否能在统一接口下给出正确结果（含解释路径）。

### L1 基础事实检索（Direct Lookup）

1. **“上周五我去了哪些地方？”**  
   - 测试点：时间范围过滤 + 地点归属。  
   - 图要求：`Event` 带时间与地点（直接属性或 `OCCURS_AT` 到 `Place/TimeSlice`），支持按时间区间检索。  
   - 检索模式：`MATCH (e:Event)-[:OCCURS_AT]->(p:Place)` + 时间范围过滤。

2. **“我在视频里提到‘人工智能’是在什么时候？”**  
   - 测试点：文本证据挂载与全文检索。  
   - 图要求：`UtteranceEvidence/TextEvidence` 与 `Event/Segment` 对齐时间，文本可检索。  
   - 检索模式：文本检索 → 对应 Utterance → 映射到 Event/TimeSlice。

3. **“画面里出现过红色的杯子吗？”**  
   - 测试点：视觉对象属性检索。  
   - 图要求：视觉 `Evidence` 或 `Entity(Object)` 描述 `name="cup", color="red"`，链接到 `MediaSegment/Event`。  
   - 检索模式：对象属性过滤 → 相关 Segment/事件。

4. **“昨天下午跟我开会的人是谁？”**  
   - 测试点：事件类型 + 参与者关系。  
   - 图要求：`Event{type="meeting"}` 与 `INVOLVES(Event→Entity(Person))`。  
   - 检索模式：时间+类型过滤的 Event → `INVOLVES` 邻居。

### L2 时序与状态流转（Temporal & State）

5. **“我回家后做的第一件事是什么？”**  
   - 测试点：基于时间顺序的“下一事件”。  
   - 图要求：`Event` 时间顺序良好，或存在 `NEXT_EVENT` 链；能以“锚点事件”为起点向后遍历。  
   - 检索模式：定位“Arrive Home”→ 查最早的 `NEXT_EVENT` 或时间上紧邻的 Event。

6. **“我昨天玩手机玩了多久？”**  
   - 测试点：时长聚合。  
   - 图要求：Event/状态中有 `duration` 或 `t_media_start/end` 信息，可按行为类型聚合。  
   - 检索模式：过滤 action="Use Phone" 的事件 + SUM(duration)。

7. **“我的车钥匙现在在哪？”**  
   - 测试点：状态随时间的最后赋值。  
   - 图要求：钥匙作为跟踪对象（Entity/Object）或状态 (`State{subject="Key"}`)，所有相关事件按时间排序可重放最后状态。  
   - 检索模式：取关于“钥匙”的所有事件/状态，按时间倒序，找到最近一次“持有者/位置”的赋值。

8. **“出门前我锁门了吗？”**  
   - 测试点：条件存在性 + 时序约束。  
   - 图要求：`Event` 中有 Lock/Unlock 动作，能判断在“离开家”前是否有 Lock 且其后没有 Unlock。  
   - 检索模式：定位“离开家”事件，在其之前的时间窗口内查 Lock/Unlock 事件并比较顺序。

### L3 多跳推理与间接关系（Multi-hop）

9. **“我和 Alice 是怎么认识的？”**  
   - 测试点：最早共同事件。  
   - 图要求：`INVOLVES` 连接 Me/Alice 与 Event，可按时间排序找到第一次共同出现事件。  
   - 检索模式：`(Me)-[:INVOLVES*1..2]-(e)<-[:INVOLVES*1..2]-(Alice)` + 最早时间。

10. **“有没有我不认识的人在我的客厅里？”**  
    - 测试点：空间限定 + 认识/不认识标记。  
    - 图要求：Event 或 Region 标记 Location="Living Room"，人物 Entity 有 known/unknown 或信任标签。  
    - 检索模式：`OCCURS_AT` 过滤客厅场景 → 参与者中筛选 unknown。

11. **“找到那个经常和 Bob 一起出现的戴眼镜的男人。”**  
    - 测试点：共现频次 +视觉属性过滤。  
    - 图要求：`CO_OCCURS_WITH` 或共现统计，Entity 有视觉属性（has_glasses）。  
    - 检索模式：基于 Bob 的 `CO_OCCURS_WITH` 统计 top-K，再按属性过滤。

12. **“这个快递箱是谁拿进来的？”**  
    - 测试点：物体引入事件溯源。  
    - 图要求：Object/Entity(Box) 与相关 Event 的连接（进入房间、被拿起等）。  
    - 检索模式：围绕 Box 的事件序列中，寻找“进入/搬动”动作的施动者 Entity。

### L4 语义泛化与多模态对齐（Semantic & Cross-modal）

13. **“我看起来很焦虑的时候都在做什么？”**  
    - 测试点：情绪标签 + 行为语义联合。  
    - 图要求：视觉证据或状态上有情绪标签（anxious），与 Event 行为/动作 semantically 对齐。  
    - 检索模式：情绪过滤 → 对应 Event 的动作/场景统计。

14. **“上周我不小心摔倒或者弄坏东西的片段。”**  
    - 测试点：抽象概念到多种具体动作的映射。  
    - 图要求：Event/动作标签能覆盖 fall/drop/break 等语义同类；知识层可有“意外/事故”归类。  
    - 检索模式：按语义类别（意外）过滤对应 Event。

15. **“帮我找一下那张写着 Wifi 密码的便利贴。”**  
    - 测试点：OCR+位置回溯。  
    - 图要求：文字 Evidence/OCR 识别“Password/SSID”等模式，关联到具体 Note 对象及空间位置。  
    - 检索模式：文本匹配 → Note 对象 → 当前/最近位置。

16. **“我说‘好冷’的时候，真的冷吗？”**  
    - 测试点：跨模态一致性/冲突检测。  
    - 图要求：语音文本与环境状态（天气/穿着/室温等）均在图内可见；至少能判断“语义 vs 视觉/环境”的一致性。  
    - 检索模式：Utterance "cold" → 时间窗口内查温度/着装/季节等状态并对比。

### L5 边缘情况与否定逻辑（Negative & Edge Cases）

17. **“上个月我有哪天完全没有出门？”**  
    - 测试点：基于缺失的反向查询。  
    - 图要求：时间轴上有足够粒度的“出门”事件记录，能生成日期全集并排除有 Outdoor 事件的日期。  
    - 检索模式：日期范围生成 → 减去有出门事件的日期集合。

18. **“在那次聚会上，我有没有和李四说话？”**  
    - 测试点：特定上下文中的否定判断。  
    - 图要求：`TALK_TO` 或对话事件挂载双方参与者；能限定在某个 Event/Session 范围内检查是否存在关系。  
    - 检索模式：锁定该 Party Event → 查是否存在与 Li Si 的对话边/Utterance 组合。

19. **“有没有谁动过我桌子上的文件？”**  
    - 测试点：小动作/异常感知。  
    - 图要求：桌子上的 File 作为对象或 Region，一旦被非本人触碰/移动应有 Event/State 记录。  
    - 检索模式：围绕 File/桌面 Region 的 Event 中，筛选 Actor != Me。

20. **“查找所有只有我和我女朋友两个人的场景（没有第三人）。”**  
    - 测试点：排他性约束。  
    - 图要求：Event 的参与者集合可枚举；能精确判断只有 {Me, Girlfriend} 且人数=2。  
    - 检索模式：`INVOLVES` 聚合，按参与者集合过滤。

---

## 二、覆盖性评估与补充场景

上面 20 个问题覆盖了：
- 基础事实检索（谁/何时/何地/做什么）；  
- 时间顺序与状态流转；  
- 多跳关系与因果/施动者溯源；  
- 情绪/意外/OCR 等多模态语义结合；  
- 基于“缺失”和“排除”的否定推理。

为了更贴近“长期记忆体”的整体能力，还需补充两类场景：

21. **作息/行为模式对比：**“最近一周我的作息和前一周相比有什么明显变化？”  
- 测试点：跨时间窗口的模式对比与聚合总结。  
- 图要求：事件/状态中有足够的标签（起床/工作/运动/娱乐），能按天/周聚合统计并对比。  
- 检索模式：按周聚合事件分布 → 计算差异 → 输出结构化差异摘要（再由 LLM 转自然语言）。

22. **多租户与视图隔离：**“只看工作账号下的会议和文档，不包含个人生活。”  
- 测试点：租户/域/scope 级隔离与查询视图。  
- 图要求：所有节点/边都有 `tenant_id`/`domain`/`memory_scope` 等隔离键，查询可严格限制在给定视图。  
- 检索模式：所有查询都带 tenant/scope 过滤；验证不会泄露其他域的数据。

> 这 22 个场景构成 v1.0 的**检索与推理对标清单**。  
> 若未来发现新的高频需求，可在此清单上增补版本号与变更记录。

---

## 三、工程落地与“Retrieval 验证”要求

从工程视角，这份清单不止是“产品需求”，更是**测试与演进的固定锚点**：

1. **Schema 设计对齐**  
   - TKG-Graph-v1.0-Ultimate 中的节点/边/属性必须能够表达上述 22 个问题所需的信息与关系；  
   - 若某个问题无法通过现有 Schema 自然表达，视为 Schema 设计缺口，而不是先改测试。

2. **分阶段能力映射（v0.6 → v1.0）**  
   - v0.2–v0.3：应完整覆盖 L1–L2 的查询（基础事实 + 时序/状态），在小规模数据上可验证；  
   - v0.4–v0.5：为 L3 部分场景提供图结构基础（共现、施动者、TimeSlice 等）、身份治理与 TTL/门控；  
   - v0.6：作为**风控与资源上限收口**，确保在开启 L3/L4 查询时不会因 hop/fanout/关系泛滥导致资源失控；  
   - v0.7：选取 2–3 个代表性的 L3/L4 场景，提供稳定的“解释型 API”（含邻居路径与证据链）；  
   - v1.0：要求在受控资源下，清单中的全部 5 层能力都可通过 API + 图查询实现，并有可回放的解释路径。

3. **Retrieval 验证（新增的工程步骤）**  
   - 在模块级 PROCESS 中，“测试验证”不只看单元测试覆盖率，还必须至少包含：  
     - 针对上述每一类问题的**端到端检索用例**（可在 `modules/memory/tests/integration` 或脚本中实现）；  
     - 每个用例明确：输入（自然语言/结构化参数）→ 预期命中图结构 → 预期结果（含解释路径）。  
   - 升级路径：  
     - v0.6 起，任何 Schema 或服务改动，都需在这份对标清单上检查“哪些场景可能受影响”；  
     - v1.0 的“发布前验收”，必须至少跑一遍对应的 Retrieval 集成测试，**不允许以“单元测试全绿”替代**。

4. **避免过度工程化的约束**  
   - 不追求“一次性支持所有可能问题”，而是以这 22 个场景为主干；  
   - 每新增一个高阶推理能力，都需要能确切指出它改善了哪一个对标问题（或新增的清单条目），否则视为过度抽象；  
   - 对于算力成本高的推理（如复杂跨周模式分析），必须有开关与频率限制，默认面向小规模数据/MVP 场景。

> 后续若有新版本（v1.x）扩展推理能力，应在本文件增加“版本记录”小节，标注新增/修改的对标场景，并说明对 Schema 与服务的影响范围。


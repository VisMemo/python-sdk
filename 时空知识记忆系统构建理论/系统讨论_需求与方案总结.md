# 时空知识记忆系统：系统讨论需求与方案总结

**版本**：v0.1  
**日期**：2024-11-14  
**目的**：汇总本轮关于时空知识记忆系统的关键讨论，将「需求 – 方案」成体系沉淀，作为后续架构演进与实现的参考基线。

---

## 1. 理论 vs 现有实现：整体差异

### 1.1 需求
- 落地《时空知识图谱的本体论与信息论基础》中的核心思想：  
  - 时空超图 STH = (V, H, τ, σ, λ)（节点/超边/时间/空间/语义）。  
  - 时间作为一等公民实体（TimeSlice），可检索、可参与关系。  
  - 时空保真度 STF、因果完整性 CI 等质量度量。  
  - 多层记忆经济学（原始感知 → 情节记忆 → 语义知识）。  
  - 图谱构建 / 修正 / 合并（ST-Graph Clustering）与可审计的演化。

### 1.2 现状问题
- 数据结构层：  
  - 当前 `MemoryEntry + Edge` 仅提供「记忆条目 + 普通边」，时间/空间/实体类型埋在 `metadata`，缺少强类型的 TimeSlice/Region/事件类型。  
  - 无超边 H，图结构为普通有向图，不支持 n 元关系。
- 时空与多源对齐：  
  - 当前实现以单视频流为主，缺少多传感器、多摄像头的时间/空间对齐层。  
  - 时间和空间只是属性，而不是可组合推理的一等对象。
- 图演化与质量度量：  
  - 有流式写入、等价审核 `/equiv/*`、TTL 与边衰减 `/admin/*`，但缺乏：  
    - 图级模式挖掘与聚类合并。  
    - 审计级 revision log。  
    - STF/CI 等质量指标及评测流水线。
- 记忆层级：  
  - 仅区分 `episodic | semantic`，缺少原始感知层与统一的“记忆经济学调度器”。

### 1.3 方案方向（高层）
- 在不破坏现有 API 的前提下演进：  
  - 保持 `MemoryEntry/Edge` 公共契约稳定。  
  - 通过新增字段/子结构，引入 TimeSlice/Region/事件类型与图演化逻辑。  
  - 先补“最缺的一层”（时间轴 + 基本时序关系），再逐步引入 STH 与质量度量。

---

## 2. 视频理解路径：模块化流水线 vs 端到端 VLM

### 2.1 需求
- 在保持核心能力（身份级追踪、精确时间、可审计）的前提下，简化视频理解流水线复杂度。  
- 评估端到端视频-LLM/记忆模型，将视频直接转换为「时间化语义描述文本」并统一走文本记忆/建图的可行性与边界。

### 2.2 现状与矛盾
- 现有流程：  
  - 视频/音频 → 探测+切片 → 抽帧 → 检测+追踪+人脸聚类+ASR → VG → `VideoGraphMapper` → Memory/Graph。  
  - 工程复杂度高，但：  
    - 支持身份级追踪与跨视频 re-ID。  
    - 时间精度到帧，可映射到物理时间。  
    - 每步可审计、可重放。
- 端到端 VLM 设想：  
  - 视频 → VLM → 带时间片的语义段落列表（事件级描述） → 文本记忆/建图。  
  - 工程上更简单，语义更自然，但：  
    - 身份追踪缺乏稳定、可索引的全局 ID。  
    - 时空几何与可验证性显著下降。  
    - 行为高度依赖模型版本与 prompt，难以保证兼容性。

### 2.3 方案：端到端作为语义适配器，而非唯一事实源
- 保留信号级流水线作为「物理事实层」：  
  - 人脸/人体/物体检测 + 追踪。  
  - 身份级 embedding + 聚类。  
  - 精确时间戳和空间元信息。
- 引入 VLM 作为「语义解释层」：  
  - 针对时间窗口或短 clip：  
    - 输入：关键帧 / 短视频片段 + 已有结构化检测结果（ID、bbox、ASR 等）。  
    - 输出：事件级语义描述与高级关系候选。  
  - VLM 输出用于补充/提升事件节点与高阶边，不直接替代底层事实。
- 策略：  
  - 面向“用户体验/摘要/问答”场景，优先使用 VLM 语义层。  
  - 面向“审计/监控/严谨时空分析”，始终以底层信号级流水线为真。

---

## 3. 身份级追踪与跨模态统一

### 3.1 需求
- 在长时间、多视频、多场景下，保持「同一人」的稳定身份表示。  
- 目标：支持人物/实体跨视频、跨日期、跨模态（图像/语音）的一致 ID。

### 3.2 现状与限制
- 现有方法：  
  - 人脸检测 + embedding + 聚类/re-ID 构建稳定轨迹与人物 ID。  
  - ID 作为图谱中的硬 key，用于关系构建与检索。  
- VLM 现状：  
  - 在单段视频或短上下文内可识别“同一个人”，但缺乏：  
    - 全局、可存储的 embedding 空间。  
    - 跨视频、跨 session 的 ID 稳定性。  
  - 无法提供“可索引的统一身份 ID”。
- 人脸 + 语音统一 ID：  
  - 现实上依赖专用 face/speaker embedding 与跨模态对齐模型。  
  - 目前 VLM 不适合作为主实现，只可能作为辅助判别器。

### 3.3 方案
- 硬要求：  
  - 身份级追踪与跨模态统一仍由专用 embedding + 聚类/re-ID 管线负责。  
  - VLM 不作为身份真相来源，只作为“语义标签 + 辅助确认”。  
- 多模态统一身份：  
  - 逐步引入 face/speaker 等 embedding 的统一 ID 映射层。  
  - 在图谱中，以此 ID 为核心节点，挂接视觉/语音/文本描述。  

---

## 4. 视频输入处理策略：抽帧 vs 片段

### 4.1 需求
- 在动作理解、时间精度与计算成本之间取得平衡。  
- 给多模态模型提供足够的时序上下文，同时保持 ID/时间等底层信息精度。

### 4.2 抽帧策略（当前）
- 优点：  
  - 有利于人脸聚类、re-ID、轨迹构建。  
  - 控制计算成本（fps、分辨率可调）。  
  - 每帧有精确时间戳，易与物理时间对齐。  
- 缺点：  
  - 多模态模型只看到离散快照，对动作/关系理解较困难，需要上层拼接。

### 4.3 片段策略（短 clip）
- 优点：  
  - 模型直接看到连续运动，适合动作/交互/因果理解。  
  - 事件级语义更接近人类叙事。  
- 缺点：  
  - 时间粒度变粗（片段级），成本更高。  
  - 片段划分策略本身复杂（长度、边界、覆盖率）。

### 4.4 综合方案
- 保留帧级抽样用于：  
  - 人脸/物体检测、ID 追踪、轨迹、几何信息。  
- 在时间轴上定义事件窗口（例如 2–5 秒）：  
  - 为每个窗口提取连续关键帧或短 clip + 结构化检测结果，喂给 VLM 做事件级语义建模。  
- 形成“两层时间”：帧级精度保证事实，片段级精度提供语义。

---

## 5. 智能图构建：从启发式到语义驱动

### 5.1 需求
- 从“硬编码 if/else 连边”演进到“语义驱动、可扩展的图构建”，减少孤立节点、提升图连通性与语义丰富度。  
- 同时保留可控性与可审计性。

### 5.2 现状
- 当前以启发式规则为主：  
  - 同帧 co-occurrence、简单关系类型（appears_in/said_by/located_in/equivalence）。  
  - 关系类型白名单严重限制扩展（已在架构演进文档中诊断）。  
  - 缺乏显式时序关系。

### 5.3 常见智能图构建路径
- 视觉 Scene Graph / Video Scene Graph：  
  - 模型直接输出 `<subject, predicate, object>`。  
  - 优点：视觉关系丰富，空间关系清晰。  
  - 缺点：谓词集固定，领域迁移成本高。
- 结构化感知 + LLM 语义建模（推荐）：  
  - 底层：检测/追踪/ASR/场景标签等产生“事实表”。  
  - 中层：把某个时间窗口内的事实表 + 代表性帧输入 LLM/VLM：  
    - 输出事件节点、语义/因果关系、高级标签。  
  - 优点：  
    - 利用 LLM 的语义整合能力，减少手写规则。  
    - 依旧基于可审计的底层事实。
- 纯 LLM/VLM 端到端建图：  
  - 不推荐作为唯一事实源，仅适合作为候选建议层。

### 5.4 方案
- 分层边模型：  
  - 低级确定性边：由启发式/检测直接生成（高精度、低召回）。  
  - 高级概率边：由 LLM/VLM 基于事实表推理，附带置信度与来源。  
- 查询层：  
  - 支持按层级和置信度过滤边。  
  - 在检索和解释时，可以显式区分“硬事实”与“衍生推理”。

---

## 6. 物理世界时间轴建模

### 6.1 需求
- 支持围绕“物理世界时间”的查询和分析：  
  - 按绝对时间检索（昨天、上周、过去三个月）。  
  - 跨视频、跨传感器对齐事件时间线。  
- 同时兼容没有物理时间意义的片段（剪辑、示例、生成内容）。

### 6.2 最小可行时间模型
- 媒体级时间（Media Time）：  
  - 每段媒体存：  
    - `recorded_at`：录制起始时间（可为空）。  
    - `duration_seconds`。  
    - `has_physical_time: bool`：是否锚定物理时间。  
- 事件级时间（Event Time）：  
  - 对每个事件/记忆：  
    - `t_media_start` / `t_media_end`：媒体内部偏移。  
    - 若 `has_physical_time = true`，则派生：  
      - `t_abs_start` / `t_abs_end = recorded_at + t_media_*`。

### 6.3 无物理时间片段的处理
- 存储：  
  - `recorded_at = null`, `has_physical_time = false`。  
  - 仍保存媒体内部时间，用于局部排序与检索。  
- 检索：  
  - 物理时间语义查询（如“昨天”）默认仅过滤 `has_physical_time = true`。  
  - 内容检索可选是否包含逻辑时间片段。  
  - 区分时间来源：  
    - `time_origin = 'physical' | 'logical' | 'ingestion'`。

---

## 7. 多租户与 API Key 驱动的记忆服务

### 7.1 需求
- 以“用户”为租户单位进行隔离：  
  - 用户持有自己的 API Key，托管与读写其记忆。  
  - 我们以 MCP / Agent Tool 的形式提供记忆基础设施。  
  - 不同 Agent/应用可代用户调用，但绝不能越权访问其他用户数据。

### 7.2 身份/权限模型
- `tenant_id`：  
  - 内部租户 ID（一个最终用户一个 tenant）。  
  - 只在服务端可见，不暴露给客户端。  
- `api_key`：  
  - 外部凭证（随机字符串），服务端存 hash。  
  - 映射到：`tenant_id + scopes(read/write/admin) + integration_id + expires_at`。  
  - 一个 tenant 可拥有多把 key（不同设备/Agent）。  
- `user_id` / `memory_domain` / `run_id`：  
  - 作为租户内部的进一步分区与命名空间（多角色/家庭成员等）。  
  - 不得跨越 `tenant_id`。

### 7.3 数据平面隔离（Qdrant + Neo4j）
- Qdrant：  
  - 初期：单集合 + payload 中写入 `tenant_id`，所有查询在服务端 adapter 中强制注入 `must: tenant_id` 过滤。  
  - 后期：大 tenant 可独立 collection，小 tenant 共用集合（hybrid 模式）。  
- Neo4j：  
  - 所有节点与边写入 `tenant_id` 属性并建立索引。  
  - 所有 Cypher 封装在 `MemoryGraphStore` / adapter 内部，统一在 WHERE 中加 `tenant_id` 过滤。  
  - 禁止外部直接拼接任意 Cypher，避免遗漏租户条件。

### 7.4 API 设计
- 认证：  
  - HTTP 请求通过 header 提供 Key：`Authorization: Bearer <api-key>` 或 `X-MOYAN-API-Key`。  
  - 认证中间件：解析 key → 查表 → 得到 `tenant_id` + `scopes` → 写入 request context。  
- 写入接口：  
  - 请求体可提供 `user_id`、`memory_domain` 等。  
  - 服务端强制注入 `tenant_id`，不允许客户端指定或覆盖。  
  - 所有写入记录在 `metadata` 中挂接 `tenant_id`/`source` 等。  
- 读取接口：  
  - 基于 `tenant_id` 做强制过滤。  
  - 支持 `scope = tenant | user` 等内部范围限定，但不跨租户。

### 7.5 Agent / MCP 集成
- MCP / Agent Tool：  
  - Tool 配置中让最终用户填写 `MOYAN_API_KEY`。  
  - 每次 Tool 调用时，MCP 框架自动携带该 Key，不暴露 `tenant_id`。  
- 记忆服务：  
  - 只根据 API Key 解析租户，不关心 Agent 实现细节。  
  - 可在 Key 元数据中记录 `integration_id`/Agent 标识，用于审计和限流。

---

## 8. 后续工作建议（简要 TODO）

1. **时间轴落地（高优先级）**  
   - 在 `MemoryEntry.metadata` 和图模型中引入媒体级/事件级时间字段及 `has_physical_time` 标记。  
   - 调整搜索接口，让 `time_range` 明确区分绝对时间与媒体内部时间。  
2. **最小多租户实现**  
   - 设计并实现 API Key 数据表与验证中间件。  
   - 在 Qdrant/Neo4j adapter 层统一注入 `tenant_id` 过滤。  
3. **事件窗口与 VLM 语义层 PoC**  
   - 定义事件窗口结构（参与实体、时间范围、检测结果）。  
   - 选用 VLM/LLM 方案，验证在事件摘要与关系提取中的效果。  
4. **图构建分层重构（低层保持、上层升级）**  
   - 保持现有启发式边作为低层事实边。  
   - 封装 LLM/VLM 生成高阶语义边，带置信度与来源信息。  
5. **与理论文档的映射表**  
   - 在本目录或相关模块中建立“理论概念 → 实现实体/字段/API”的对照表，便于长期演进。

